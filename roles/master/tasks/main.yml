---
- name: Init Kubernetes cluster
  shell: |
    kubeadm init --service-cidr {{ service_cidr }} \
                 --kubernetes-version {{ kube_version }} \
                 --pod-network-cidr {{ pod_network_cidr }} \
                 --apiserver-advertise-address {{ groups['master'][0] }} \
                 --token {{ token }} \
                 --skip-preflight-checks
  run_once: true
  register: init_cluster

- name: Create Kubernetes config directory
  file: path=/root/.kube/ state=directory

- name: Copy admin.conf to Home directory
  when: init_cluster|succeeded
  copy:
    src: "{{ kubeadmin_config }}"
    dest: "/root/.kube/config"
    owner: root
    group: root
    mode: 0755
    remote_src: True

- name: Wait until node is available
  shell: kubectl get no | grep {{ ansible_hostname }}
  register: get_node_result
  until: get_node_result.rc == 0
  retries: 10
  delay: 1
  
- name: Taint master node
  when:
    - init_cluster|succeeded
    - taint_master
  shell: |
    kubectl taint nodes --all node-role.kubernetes.io/master-

- name: Set master label
  when:
    - init_cluster|succeeded
    - get_node_result|succeeded
  shell: |
    kubectl label node {{ ansible_hostname }} \
        kubeadm.alpha.kubernetes.io/role=master

- name: Set master run fact
  set_fact:
    master_have_run: true

